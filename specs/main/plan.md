# Implementation Plan: SF Parking Occupancy Time Visualizer

**Branch**: `main` | **Date**: 2025-12-17 | **Updated**: 2025-12-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/main/spec.md`

## Summary

Build a browser-based visualization tool that displays San Francisco on-street parking occupancy data with configurable time components. Users can adjust time range, aggregation buckets (15min to monthly), statistical measures (avg, median, percentiles), **switchable series dimensions** (Areas of Interest, Day of Week, Time of Day), date/time patterns (weekdays, peak hours), and chart types including multiple heatmap modes. The tool uses **ECharts** for visualization and static pre-generated data with vanilla HTML/CSS/JavaScript for UI controls per constitution requirements.

**Key Update (2025-12-19)**: Added series dimension switching with horizontal tabs (AOI | Day of Week | Time of Day). Redundant filters are hidden when series dimension conflicts. "San Francisco" added as aggregate AOI.

## Technical Context

**Language/Version**: JavaScript ES2020+ (no transpilation required)
**Primary Dependencies**: ECharts 5.x (via CDN)
**Storage**: Static JSON file (~5MB, 90 days × 6 regions × 96 readings/day)
**Testing**: Native browser test runner or simple HTML test harness
**Target Platform**: Modern browsers (Chrome, Firefox, Safari, Edge - latest 2 versions)
**Project Type**: Single project (static web application)
**Performance Goals**: 60fps chart rendering, <100ms parameter response, <500ms initial load
**Constraints**: ECharts is the only external library; no build step required; offline-capable after initial load
**Scale/Scope**: ~50,000 data points, 9 configurable dimensions (including series dimension switching), 7 chart types (including 3 heatmap modes)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Simplicity First (YAGNI) | ✅ PASS | Single external dependency (ECharts), minimal abstractions |
| II. User Experience First | ✅ PASS | Sensible defaults, <100ms feedback, progressive disclosure |
| III. Performance & Responsiveness | ✅ PASS | ECharts canvas rendering, 60fps target, <500ms load |
| IV. Browser-Native Development | ✅ PASS | Vanilla JS for UI; ECharts permitted per amended constitution (v1.1.0) |
| V. Testable Visualization Logic | ✅ PASS | Pure functions for statistics/time, separated from ECharts rendering |

**Gate Result**: PASS - ECharts dependency justified per Constitution v1.1.0 amendment.

**Post-Design Re-evaluation (2025-12-19)**: All gates remain PASSED.
- Series dimension switching adds complexity but serves explicit user requirement (comparative analysis)
- X-axis behavior (time for DoW, days for ToD) follows natural mapping of series→axis dimensions
- No additional dependencies introduced beyond ECharts

## Project Structure

### Documentation (this feature)

```text
specs/main/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Technical decisions
├── data-model.md        # Entity definitions
├── quickstart.md        # Developer setup guide
├── contracts/           # Module API contracts
│   ├── statistics.js.md
│   ├── time-utils.js.md
│   ├── data-loader.js.md
│   ├── chart.js.md
│   └── controls.js.md
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── index.html           # Entry point, ECharts CDN script tag
├── main.js              # Application bootstrap, orchestration
├── styles.css           # All styles with CSS custom properties
├── lib/
│   ├── statistics.js    # Pure statistical calculation functions
│   ├── time-utils.js    # Date/time filtering and bucketing
│   └── data-loader.js   # JSON loading and validation
├── ui/
│   ├── controls.js      # Control panel UI and events
│   └── chart.js         # ECharts wrapper and configuration
└── data/
    └── parking-data.json # Static sample data (generated)

tests/
├── unit/
│   ├── statistics.test.js
│   └── time-utils.test.js
└── test-runner.html     # Simple browser-based test runner
```

**Structure Decision**: Single project with flat module structure per Constitution Technical Standards. ECharts loaded via CDN. ES Modules for application code. Static file server sufficient for development.

## Module Dependency Graph

```
                    ┌──────────────┐
                    │  index.html  │
                    │  + ECharts   │
                    └──────┬───────┘
                           │
                    ┌──────▼───────┐
                    │   main.js    │
                    └──────┬───────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼────┐      ┌─────▼─────┐     ┌─────▼─────┐
    │controls │      │   chart   │     │data-loader│
    │   .js   │      │    .js    │     │    .js    │
    └─────────┘      │ (ECharts) │     └─────┬─────┘
                     └───────────┘           │
                                             │
                     ┌───────────────────────┼───────────────────────┐
                     │                       │                       │
               ┌─────▼─────┐          ┌──────▼──────┐         ┌──────▼──────┐
               │time-utils │          │ statistics  │         │parking-data │
               │    .js    │          │    .js      │         │   .json     │
               └───────────┘          └─────────────┘         └─────────────┘
```

## Data Pipeline

```
User Action (control change)
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Filter by TimeRange                                          │
│    readings.filter(r => isInRange(r.timestamp, timeRange))     │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Filter by AOI (Areas of Interest)                            │
│    readings.filter(r => aois.includes(r.aoiId))                │
│    "San Francisco" = aggregate of all neighborhood AOIs        │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Filter by DatePattern                                        │
│    filterByDayOfWeek(readings, pattern.days)                   │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Filter by TimePattern                                        │
│    filterByHourRange(readings, pattern.ranges)                 │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. Bucketize                                                    │
│    bucketize(readings, aggregation) → Map<bucketKey, readings> │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. Calculate Statistics per Bucket                              │
│    For each bucket: calculate(occupancyRates, statisticType)   │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 7. Group by Series Dimension + Set X-Axis                       │
│    AOI → series per selected AOI; x-axis = time/dates          │
│    Day of Week → series per day (Sun-Sat); x-axis = hours      │
│    Time of Day → series per period; x-axis = days of week      │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 8. Transform to ECharts Option                                  │
│    Build series[], xAxis, yAxis, tooltip config                │
└────────────────────────────────────────────────────────────────┬┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ 9. Render with ECharts                                          │
│    chart.setOption(option)                                     │
└─────────────────────────────────────────────────────────────────┘
```

## ECharts Chart Type Mapping

| App Chart Type | ECharts Configuration | Notes |
|---------------|----------------------|-------|
| Line | `series: [{ type: 'line' }]` | Default, smooth optional |
| Bar | `series: [{ type: 'bar' }]` | Grouped for multiple series |
| Area | `series: [{ type: 'line', areaStyle: {} }]` | Fill under line |
| Stacked Area | `series: [{ type: 'line', areaStyle: {}, stack: 'total' }]` | Series stacked |
| Heatmap (date×hour) | `series: [{ type: 'heatmap' }]` | X=hour (0-23), Y=dates |
| Heatmap (day×hour) | `series: [{ type: 'heatmap' }]` | X=hour (0-23), Y=Mon-Sun |
| Calendar Heatmap | `calendar: {...}, series: [{ type: 'heatmap', coordinateSystem: 'calendar' }]` | GitHub-style month view |

## Static Data Generation

The parking data file (`src/data/parking-data.json`) will be pre-generated with these characteristics:

### Realistic Patterns

| Pattern | Implementation |
|---------|----------------|
| Weekday vs Weekend | Weekdays 20-30% higher baseline |
| Business Hours | Peak 10am-2pm, 5pm-8pm |
| Regional Variation | Downtown: 85% avg, Sunset: 55% avg |
| Noise | ±5-10% random variation |
| Seasonal Trend | Slight increase Jan→Mar |

### Data Volume

| Metric | Value |
|--------|-------|
| Time Range | 90 days (Jan 1 - Mar 31, 2024) |
| Regions | 6 (Downtown, SOMA, Mission, Marina, Richmond, Sunset) |
| Reading Interval | 15 minutes |
| Readings per Day | 96 (24 hours × 4) |
| Total Readings | ~51,840 (90 × 96 × 6) |
| Estimated File Size | ~4-5 MB |

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| ECharts dependency (~1MB) | Rich chart types including heatmaps, animations, tooltips | Native Canvas would require 10x code; Constitution amended to permit |

## Implementation Order

Based on user story priorities from spec.md:

### Phase 1: Foundation (P1 Stories)
1. Project setup (index.html with ECharts CDN, main.js, styles.css)
2. Data loader module + static data file generation
3. Time utilities module (bucketing, filtering basics)
4. Statistics module (core calculations)
5. ECharts wrapper (basic line chart)
6. Time range control
7. Aggregation bucket control

### Phase 2: Analysis Features (P2 Stories)
8. Statistics selector (all types)
9. **Series dimension tabs (AOI | Day of Week | Time of Day)**
10. AOI selector with "San Francisco" aggregate
11. Date pattern filter (weekday/weekend/custom) - hidden when Day of Week series active
12. **Filter visibility logic** - hide redundant filters based on active series dimension

### Phase 3: Advanced Features (P3 Stories)
13. Time pattern filter (morning/peak/custom) - hidden when Time of Day series active
14. Additional chart types (bar, area, stacked)
15. Heatmap modes (date×hour, day×hour, calendar)
16. Precision control
17. Polish (animations, accessibility, performance)

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Large JSON file slow to load | Gzip compression; lazy load by region if >500ms |
| ECharts learning curve | Well-documented; examples available |
| Heatmap complexity | ECharts has built-in calendar component |
| Browser compatibility | ECharts handles cross-browser rendering |

## Next Steps

1. Run `/speckit.tasks` to generate detailed implementation tasks
2. Generate static parking data file
3. Implement in phase order, validating each user story independently
