<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Parking Visualizer - Test Runner</title>
    <style>
        :root {
            --color-pass: #2ecc71;
            --color-fail: #e74c3c;
            --color-pending: #f39c12;
            --color-text: #2c3e50;
            --color-muted: #7f8c8d;
            --color-bg: #f5f7fa;
            --color-surface: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.5;
        }

        h1 {
            margin-bottom: 20px;
        }

        .summary {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-count {
            font-size: 2rem;
            font-weight: bold;
        }

        .summary-label {
            color: var(--color-muted);
            font-size: 0.875rem;
        }

        .pass { color: var(--color-pass); }
        .fail { color: var(--color-fail); }
        .pending { color: var(--color-pending); }

        .test-suite {
            background: var(--color-surface);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .suite-header {
            background: #ecf0f1;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .test-case {
            padding: 10px 16px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-case:last-child {
            border-bottom: none;
        }

        .test-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .test-icon.pass { background: var(--color-pass); }
        .test-icon.fail { background: var(--color-fail); }

        .test-name {
            flex: 1;
        }

        .test-time {
            color: var(--color-muted);
            font-size: 0.875rem;
        }

        .test-error {
            background: #fdecea;
            padding: 10px 16px 10px 46px;
            color: var(--color-fail);
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }

        .running {
            padding: 20px;
            text-align: center;
            color: var(--color-muted);
        }

        .btn-run {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .btn-run:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <h1>Test Runner</h1>
    <button class="btn-run" onclick="runAllTests()">Run All Tests</button>

    <div class="summary" id="summary">
        <div class="summary-item">
            <div class="summary-count" id="total-count">0</div>
            <div class="summary-label">Total</div>
        </div>
        <div class="summary-item">
            <div class="summary-count pass" id="pass-count">0</div>
            <div class="summary-label">Passed</div>
        </div>
        <div class="summary-item">
            <div class="summary-count fail" id="fail-count">0</div>
            <div class="summary-label">Failed</div>
        </div>
    </div>

    <div id="results"></div>

    <script type="module">
        // Simple test framework
        const suites = [];
        let currentSuite = null;

        window.describe = function(name, fn) {
            currentSuite = { name, tests: [] };
            suites.push(currentSuite);
            fn();
            currentSuite = null;
        };

        window.it = function(name, fn) {
            if (currentSuite) {
                currentSuite.tests.push({ name, fn });
            }
        };

        window.expect = function(actual) {
            return {
                toBe(expected) {
                    if (actual !== expected) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toEqual(expected) {
                    if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeCloseTo(expected, precision = 2) {
                    const factor = Math.pow(10, precision);
                    if (Math.round(actual * factor) !== Math.round(expected * factor)) {
                        throw new Error(`Expected ${expected} (within ${precision} decimals), got ${actual}`);
                    }
                },
                toBeTruthy() {
                    if (!actual) {
                        throw new Error(`Expected truthy value, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeFalsy() {
                    if (actual) {
                        throw new Error(`Expected falsy value, got ${JSON.stringify(actual)}`);
                    }
                },
                toContain(item) {
                    if (!actual.includes(item)) {
                        throw new Error(`Expected ${JSON.stringify(actual)} to contain ${JSON.stringify(item)}`);
                    }
                },
                toHaveLength(length) {
                    if (actual.length !== length) {
                        throw new Error(`Expected length ${length}, got ${actual.length}`);
                    }
                },
                toThrow() {
                    let threw = false;
                    try {
                        actual();
                    } catch (e) {
                        threw = true;
                    }
                    if (!threw) {
                        throw new Error('Expected function to throw');
                    }
                }
            };
        };

        // Load test files
        async function loadTests() {
            try {
                await import('./unit/statistics.test.js');
            } catch (e) {
                console.log('statistics.test.js not found or has errors:', e.message);
            }

            try {
                await import('./unit/time-utils.test.js');
            } catch (e) {
                console.log('time-utils.test.js not found or has errors:', e.message);
            }
        }

        // Run all tests
        window.runAllTests = async function() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '<div class="running">Running tests...</div>';

            // Clear previous results
            suites.length = 0;

            // Reload tests
            await loadTests();

            let totalCount = 0;
            let passCount = 0;
            let failCount = 0;
            let html = '';

            for (const suite of suites) {
                let suitePass = 0;
                let suiteFail = 0;
                let testsHtml = '';

                for (const test of suite.tests) {
                    totalCount++;
                    const start = performance.now();
                    let passed = false;
                    let error = null;

                    try {
                        await test.fn();
                        passed = true;
                        passCount++;
                        suitePass++;
                    } catch (e) {
                        failCount++;
                        suiteFail++;
                        error = e.message;
                    }

                    const time = (performance.now() - start).toFixed(1);
                    const icon = passed ? '&#10003;' : '&#10007;';
                    const iconClass = passed ? 'pass' : 'fail';

                    testsHtml += `
                        <div class="test-case">
                            <div class="test-icon ${iconClass}">${icon}</div>
                            <div class="test-name">${test.name}</div>
                            <div class="test-time">${time}ms</div>
                        </div>
                        ${error ? `<div class="test-error">${error}</div>` : ''}
                    `;
                }

                const suiteStatus = suiteFail === 0 ? 'pass' : 'fail';
                html += `
                    <div class="test-suite">
                        <div class="suite-header">
                            <span>${suite.name}</span>
                            <span class="${suiteStatus}">${suitePass}/${suite.tests.length}</span>
                        </div>
                        ${testsHtml}
                    </div>
                `;
            }

            resultsEl.innerHTML = html || '<div class="running">No tests found. Create test files in tests/unit/</div>';

            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('pass-count').textContent = passCount;
            document.getElementById('fail-count').textContent = failCount;
        };

        // Auto-run on load
        loadTests().then(() => {
            if (suites.length > 0) {
                runAllTests();
            }
        });
    </script>
</body>
</html>
